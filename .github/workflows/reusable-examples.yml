name: Reusable examples workflow

on:
  workflow_call: {}

env:
  ASTRO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: "1"
  NEXT_TELEMETRY_DISABLED: "1"
  TURBO_TELEMETRY_DISABLED: "1"
jobs:
  bun-examples:
    name: ${{matrix.folder}}
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            objects.githubusercontent.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
          disable-sudo-and-containers: true
          egress-policy: block
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version: 1.2.19
      - run: bun install && bun run build
      - run: bun install
        working-directory: "examples/${{matrix.folder}}"
      - run: bun tsc --noEmit
        working-directory: "examples/${{matrix.folder}}"
    strategy:
      matrix:
        folder:
          - bun-rate-limit
  deno-examples:
    name: ${{matrix.folder}}
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          allowed-endpoints: >
            api.github.com:443
            deno.com:443
            github.com:443
            jsr.io:443
            objects.githubusercontent.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
          disable-sudo-and-containers: true
          egress-policy: block
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
      - uses: denoland/setup-deno@bdaa2e4f849cbc8d7b46337cf37db0dc9b321074 # v2.0.3
        with:
          deno-version: v2.4.2
      - run: npm ci && npm run build
      - run: deno install
        working-directory: "examples/${{matrix.folder}}"
      - run: deno check
        working-directory: "examples/${{matrix.folder}}"
    strategy:
      matrix:
        folder:
          - deno-sensitive-info
  node-examples:
    name: ${{matrix.folder}}
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          allowed-endpoints: >
            api.github.com:443
            binaries.prisma.sh:443
            decide.arcjet.com:443
            fonts.googleapis.com:443
            fonts.gstatic.com:443
            github.com:443
            nodejs.org:443
            objects.githubusercontent.com:443
            raw.githubusercontent.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
            unpkg.com:443
          disable-sudo-and-containers: true
          egress-policy: block
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
      - run: npm ci && npm run build
      - run: npm ci
        working-directory: "examples/${{matrix.folder}}"
      - env:
          # Astro integration checks for an `ARCJET_KEY`.
          ARCJET_KEY: ajkey_dummy
          # Used by Clerk examples: the smallest dummy token that passes the Clerk validation.
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_LiQ=
        run: npm run build --if-present
        working-directory: "examples/${{matrix.folder}}"
      - run: npm run typecheck
        working-directory: "examples/${{matrix.folder}}"
    strategy:
      matrix:
        folder:
          - astro
          - express-bots
          - express-newman
          - express-rate-limit
          - express-sensitive-info
          - express-validate-email
          - fastify
          - nestjs
          - nextjs-app-dir-rate-limit
          - nextjs-app-dir-validate-email
          - nextjs-bot-categories
          - nextjs-decorate
          - nextjs-ip-details
          - nextjs-pages-wrap
          - nextjs-react-hook-form
          - nextjs-sensitive-info
          - nextjs-server-actions
          - nodejs-rate-limit
          - react-router-middleware
          - react-router
          - remix-express
          - sveltekit
